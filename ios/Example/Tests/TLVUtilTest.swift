//
//  File.swift
//  imKeyConnector_Tests
//
//  Created by joe on 1/5/19.
//  Copyright Â© 2019 CocoaPods. All rights reserved.
//

import XCTest
import imKeyConnector


class TLVUtilTest: XCTestCase {
  func testFindValue(){
    let cert = "7F2181C6931018090000000000860001010000000147420200015F200401020304950200805F2504201810145F2404FFFFFFFF53007F4947B0410439DFDAB30E12843B3F48CE072AD6390C7DA17B7DD66C6885DDD52ED21F86F193D3C41751D7FDBB29B1A6DC7781DB56F804BC839352741417B094C779D3A89379F002DFFE5F37483046022100A28C4C2D7F837C7C0A8BE97E27941540A97B0927404EBC7A034C1CD559685D23022100D8BC604E4C9AA9535C45E7A74A129EDD9CBFBF5A03BC81557392ABB6DED7EB31"
    let value = try! TLVUtil.find7F49(cert: cert)
    XCTAssertEqual("B0410439DFDAB30E12843B3F48CE072AD6390C7DA17B7DD66C6885DDD52ED21F86F193D3C41751D7FDBB29B1A6DC7781DB56F804BC839352741417B094C779D3A89379F002DFFE", value)
  }
  
  func testDecodeTlv(){
//    let tlv = "304402202ACECDA07C17EAF83FC40EA3887267B5BB87E5C6286CFB5B5C0C1F6F8AFB17DE02207C3C7BD07E553BB5D19201D01CDA50388023F79593189330E0794D78AAAD0269"
    
    let tlv = "304502202E272A002ACFC795327B5C6396BE6190F7238CBA394BAE32E9AEBFCA6419F025022100D1A2CA6A331B253FAA434A7F5105D14C00FFD13CF5A35314A7C64B9A550DB1E3"
    
    let tlvObjs = try! TLVUtil.decodeTLV(tlv: tlv)
    Log.d(tlvObjs)
    let childTlvs = tlvObjs[0].value as! [TlvObject]
    let r = childTlvs[0].length == 32 ? childTlvs[0].value as! String
      : (childTlvs[0].value as! String).key_substring(from: 2)
    let s = childTlvs[1].length == 32 ? childTlvs[1].value as! String
      : (childTlvs[1].value as! String).key_substring(from: 2)
    
    Log.d("r:\(r)")
    Log.d("s:\(s)")
  }
  
  func testEncodeSignature(){
    let r = "2acecda07c17eaf83fc40ea3887267b5bb87e5c6286cfb5b5c0c1f6f8afb17de"
    let s = "7c3c7bd07e553bb5d19201d01cda50388023f79593189330e0794d78aaad0269"

    let sig = try! TLVUtil.encodeSignature(r: r, s: s)
    
    let expectSig = "304402202ACECDA07C17EAF83FC40EA3887267B5BB87E5C6286CFB5B5C0C1F6F8AFB17DE02207C3C7BD07E553BB5D19201D01CDA50388023F79593189330E0794D78AAAD0269"
    
    XCTAssertEqual(sig, expectSig)
  }
}
